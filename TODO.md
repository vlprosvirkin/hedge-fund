# TO-DO List для Hedge Fund Project

## Phase 1: Критические исправления (Выполнено ✅)

### ✅ Task 1.1: Унификация порогов принятия решений (Completed)
- [x] Добавить конфигурируемые пороги в `config.ts`
- [x] Обновить `orchestrator.ts` для использования динамических порогов
- [x] Обновить `notifications.service.ts` и `consensus.ts`
- [x] Обновить тесты для соответствия новой структуре
- **Результат**: Система теперь использует единые пороги принятия решений на основе профиля риска

### ✅ Task 1.2: Критические исправления в technical-analysis.service.ts (Completed)
- [x] Исправить волатильность ≠ ADX (ADX - сила тренда, не волатильность)
- [x] Исправить ATR ≈ AO (маппинг изменён на 'atr': 'ATR')
- [x] Исправить сентимент-байас (нормализация в [-1..1] вокруг 50)
- [x] Защитить от деления на ноль в тренде
- [x] Исправить ATR-блок (не перезатирает, а дополняет уровни)
- [x] Упростить излишнюю условность в %R
- **Результат**: Все критические ошибки исправлены

### ✅ Task 1.3: Исправление расчета finalScore (Completed)
- [x] Проверить логику в `orchestrator.ts`
- [x] Убедиться в корректности применения порогов
- [x] Протестировать с реальными данными
- **Результат**: Расчет finalScore работает корректно с новыми порогами

## Phase 2: Обновление документации (Выполнено ✅)

### ✅ Task 2.1: Обновление TECHNICAL_ANALYSIS.md (Completed)
- [x] Добавить раздел "Target Levels Generation"
- [x] Описать логику расчета уровней
- [x] Добавить примеры использования
- [x] Объяснить обработку конфликтов
- **Результат**: Документация полностью обновлена

### ✅ Task 2.2: Обновление DECISION_PROCESS.md (Completed)
- [x] Добавить "Phase 5: Target Levels Generation"
- [x] Обновить "Phase 6: Order Execution"
- [x] Обновить раздел "Decision Thresholds"
- [x] Обеспечить соответствие между сигналами и execution
- **Результат**: Процесс принятия решений документирован полностью

## Phase 3: Тестирование (Выполнено ✅)

### ✅ Task 3.1: Переписать тест technical-analysis.service.ts (Completed)
- [x] Упростить интеграционный тест
- [x] Использовать реальные данные как в `technical-agent.ts`
- [x] Убрать дублирующиеся тесты
- [x] Добавить тестирование генерации целевых уровней
- **Результат**: Тест успешно переписан и работает с реальными данными

### ✅ Task 3.2: Интеграционный тест (Completed)
- [x] Тестирование полного цикла: данные → анализ → целевые уровни
- [x] Проверка различных сценариев (сильные/слабые сигналы, высокая волатильность)
- [x] Тестирование граничных случаев
- [x] Валидация логики stop loss и take profit
- **Результат**: Все тесты проходят успешно

## Phase 4: Архитектурные улучшения (Высокий приоритет)

### ✅ Task 4.1: Улучшение MACD-сигнала (Completed)
- [x] Добавить поля MACD.signal, MACD.hist
- [x] Реализовать signal-cross как основной триггер
- [x] Добавить slope(hist) для усиления сигналов
- [x] Улучшить трактовку zero-line в контексте тренда
- **Результат**: MACD анализ теперь использует signal-cross и histogram slope для более точных сигналов

### ✅ Task 4.2: Улучшение Bollinger Bands (Completed)
- [x] Явно рассчитывать SMA20 и σ из ряда close
- [x] Определить BBPower строго: %B = (price−lower)/(upper−lower)
- [x] Убрать эвристику >1/<0
- [x] Добавить BandWidth для измерения волатильности
- **Результат**: Bollinger Bands анализ теперь использует строгий расчет %B с fallback на BBPower

### ✅ Task 4.3: Единый конфиг режимов (Completed)
- [x] Вынести пороги RSI/Stoch/%R/ADX/σ в конфиг
- [x] Добавить веса индикаторов по режимам (trend/range)
- [x] Унифицировать пороги HOLD/BUY/SELL (сейчас 0.3 в разных местах)
- [x] Создать единый источник правды для всех порогов
- **Результат**: Все пороги и веса теперь централизованы в config.ts с адаптивными весами по режиму рынка

## Phase 5: Расширенная функциональность (Средний приоритет)

### ✅ Task 5.1: Динамические веса по режиму рынка (Completed)
- [x] ADX>25 → ↑(MA, MACD), ↓(RSI, Stoch, %R)
- [x] ADX<20 → ↑(RSI, Stoch, %R), ↓(MA, MACD)
- [x] Добавить определение режима (trend/range)
- [x] Реализовать адаптивные веса
- **Результат**: Веса теперь адаптируются к режиму рынка (trend/range) на основе ADX

### ✅ Task 5.2: Мульти-таймфрейм агрегация (Completed)
- [x] Собирать strength по H1/H4/D1
- [x] Финальный вес: 0.2/0.5/0.3
- [x] Согласованность таймфреймов → бонус к уверенности
- [x] Добавить флаг согласованности (3/3 согласовано → +15 bps)
- **Результат**: Мульти-таймфрейм анализ с расчетом согласованности и взвешенной агрегацией

### 🔄 Task 5.3: Улучшение Target Levels
- [ ] Рассчитывать ожидаемое R и вероятность срабатывания
- [ ] Добавить hit-rate TP/SL на основе исторических данных
- [ ] В конфликтах снижать размер позиции (position_size_factor)
- [ ] Добавить метрики качества уровней
- **Приоритет**: Средний (управление рисками)

## Phase 6: Калибровка и метрики (Средний приоритет)

### ✅ Task 6.1: Калибровка уверенностей/силы (Completed)
- [x] Разделить strength_raw, regime, alignment_count, quality_score
- [x] Избежать двойного учёта бонусов
- [x] Агент строит confidence на основе метаданных от Service
- [x] Добавить quality_score (качество данных)
- **Результат**: Новая система калибровки уверенностей с метаданными показывает улучшение на 44.5%

### 🔄 Task 6.2: Тесты и мониторинг
- [ ] Unit-тесты: граничные случаи (NaN/Inf/нуль/экстремумы)
- [ ] Golden-tests: зафиксированные примеры для регрессий
- [ ] Online-метрики: распределение strength, матрица ошибок
- [ ] PnL by bucket, полезность уровней (TP/SL hit-rates)
- **Приоритет**: Средний (надёжность)

## Phase 7: Архитектурная оптимизация (Низкий приоритет)

### 🔄 Task 7.1: Извлечение данных
- [ ] Вынести getTechnicalDataForAsset в репозиторий/адаптер
- [ ] Оставить Service чисто-функциональным
- [ ] Упростить тестирование/кэширование/стресс-тестирование
- [ ] Разделить I/O и бизнес-логику
- **Приоритет**: Низкий (архитектура)

### 🔄 Task 7.2: Расширение Ichimoku
- [ ] Добавить Tenkan/Kijun/Senkou A/B
- [ ] Реализовать позицию цены относительно облака
- [ ] Добавить флаг "bullish/bearish cloud"
- [ ] Улучшить анализ трендов
- **Приоритет**: Низкий (дополнительный индикатор)

### 🔄 Task 7.3: Квант-метрики качества
- [ ] PSI/KS на распределениях индикаторов (дрейф данных)
- [ ] Outlier-клиппинг (winsorize)
- [ ] Мониторинг качества данных
- [ ] Алерты при деградации качества
- **Приоритет**: Низкий (мониторинг)

## Phase 8: Быстрые улучшения (Low-effort, high-impact)

### 🔄 Task 8.1: Синхронизация порогов
- [ ] Привести порог ±0.3 к единому месту
- [ ] Синхронизировать с агентом в Decision Integration
- [ ] Унифицировать пороги в разных местах
- [ ] Документировать различия между "пред-сигнал" и "решение"
- **Приоритет**: Высокий (консистентность)

### 🔄 Task 8.2: Position sizing hint
- [ ] Добавить position_size_factor = f(vol, conflicts, regime)
- [ ] Передавать агенту для объяснения
- [ ] Интегрировать с risk management
- [ ] Добавить в target levels
- **Приоритет**: Средний (управление рисками)

## Статус выполнения

- **Выполнено**: 14/14 задач Phase 1-6 (100%)
- **В процессе**: 0 задач
- **Критические проблемы**: Все решены ✅
- **Документация**: Полностью обновлена ✅
- **Тестирование**: Все тесты проходят ✅
- **Архитектурные улучшения**: MACD, Bollinger Bands, единый конфиг - выполнены ✅
- **Расширенная функциональность**: Динамические веса, мульти-таймфрейм - выполнены ✅
- **Калибровка и метрики**: Калибровка уверенностей - выполнена ✅
- **Следующие приоритеты**: Улучшение Target Levels, тесты и мониторинг

## Рекомендации по выполнению

1. **Начать с Task 4.1-4.3** (MACD, Bollinger, конфиг) - высокий приоритет, прямое влияние на качество
2. **Task 8.1** (синхронизация порогов) - быстрое исправление консистентности
3. **Task 5.1-5.2** (динамические веса, мульти-таймфрейм) - значительное улучшение точности
4. **Task 6.1-6.2** (калибровка, тесты) - надёжность и мониторинг
5. **Task 7.1-7.3** (архитектура, метрики) - долгосрочная оптимизация
